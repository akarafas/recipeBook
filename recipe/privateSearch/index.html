<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Comp426 Private Search</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css" />
    </head>

    <body>
        <div id="root"></div>
        <!-- Include links to JavaScript files below -->
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <script src="../node_modules/axios/dist/axios.js"></script>
        <script src="script.js"></script>
        <section class="hero is-warning" id="searchRecipes">
                <div class="hero-body">
                <div class="container">
                <h1 class="title">
                  Search for Recipes!
                </h1>
                <h2 class="subtitle">
                <br>
                <input class="input" type="search" id="txt-search" placeholder="Type here">
                <p id="output"></p>
                <ul id="matches"></ul>
                </h2>
                </div>
                </div>
                </section>`
        <script>
            const KEY = 'debounce-terms';

            let init = function(){
                document.getElementById('txt-search').addEventListener('input', efficientSearch);

                let jwt = localStorage.getItem('jwt');

                const priRoot = new axios.create({
                    baseURL: "http://localhost:3000/private"
                })

                async function getRecipes() {
                    return await priRoot.get('/recipes', {
                        headers: { Authorization: `Bearer ${jwt}` }
                    });
                }

                let terms;

                (async () => {
                    let info = await getRecipes();
                    terms = Object.keys(info.data.result).sort();
                })();

                localStorage.setItem(KEY, JSON.stringify(terms));
            }

            let search = function(ev){
                let text = ev.target.value;
                document.getElementById('output').textContent = `List Matching ${text}`;
                let ul = document.getElementById('matches');

                getList(text)
                .then((list)=>{
                    ul.innerHTML = '';
                    if(list.length == 0){
                        let li = document.createElement('li');
                        li.textContent = "NO MATCHES";
                        ul.appendChild(li);
                    } else {
                        list.forEach(item=>{
                            let li = document.createElement('li');
                            li.textContent = item;
                            ul.appendChild(li);
                        })
                    }
                })
                .catch(err=>console.warn(err));
            }

            let getList = function(txt){
                return new Promise((resolve, reject)=>{
                    let r = Math.floor(Math.random()*1000);
                    setTimeout((function(){
                        let t = '^' + this.toString();
                        let pattern = new RegExp(t, 'i'); //starts with t
                        let terms = JSON.parse(localStorage.getItem(KEY));
                        let matches = terms.filter(term => pattern.test(term));
                        console.log('matches', matches);
                        resolve(matches);
                    }).bind(txt), r); 
                })
            }

            let debounce = function(func, wait, immediate) {
                var timeout;
                return function() {
                    var context = this, args = arguments;
                    var later = function() {
                        timeout = null;
                        if (!immediate) func.apply(context, args);
                    };
                    var callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) func.apply(context, args);
                };
            };

            let efficientSearch = debounce(function(ev){
                let text = ev.target.value;
                document.getElementById('output').textContent = `List Matching ${text}`;
                let ul = document.getElementById('matches');
    
                //call an asynchronous search to match what has been typed
                getList(text)
                .then((list)=>{
                    ul.innerHTML = '';
                    if( list.length == 0){
                        let li = document.createElement('li');
                        li.textContent = "NO MATCHES";
                        ul.appendChild(li);
                    }else{
                        list.forEach(item=>{
                            let li = document.createElement('li');
                            li.textContent = item;
                            ul.appendChild(li);
                        })
                    }
                })
                .catch(err=>console.warn(err));
            }, 300);

            document.addEventListener('DOMContentLoaded', init);
        </script>
    </body>
</html>